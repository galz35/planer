CREATE PROCEDURE dbo.sp_Equipo_ObtenerHoy @carnetsList NVARCHAR(MAX), @fecha DATE AS BEGIN SET NOCOUNT ON; DECLARE @d0 DATETIME2(0) = CONVERT(DATETIME2(0), @fecha); DECLARE @d1 DATETIME2(0) = DATEADD(DAY, 1, @d0); CREATE TABLE #Carnets ( carnet VARCHAR(20) NOT NULL PRIMARY KEY ); INSERT INTO #Carnets(carnet) SELECT DISTINCT CONVERT(VARCHAR(20), LTRIM(RTRIM(s.value))) FROM STRING_SPLIT(@carnetsList, ',') s WHERE LTRIM(RTRIM(s.value)) <> ''; ;WITH UsuariosFiltrados AS ( SELECT u.idUsuario, u.carnet FROM p_Usuarios u INNER JOIN #Carnets c ON c.carnet = u.carnet ) SELECT uf.idUsuario, uf.carnet, SUM(CASE WHEN t.idTarea IS NOT NULL AND t.estado IN ('Pendiente','EnCurso','Pausa','Bloqueada','Revision') AND t.fechaObjetivo < @d0 THEN 1 ELSE 0 END) AS retrasadas, SUM(CASE WHEN t.idTarea IS NOT NULL AND t.estado IN ('Pendiente','EnCurso','Pausa','Bloqueada','Revision') AND t.fechaObjetivo >= @d0 THEN 1 ELSE 0 END) AS planificadas, SUM(CASE WHEN t.idTarea IS NOT NULL AND t.estado = 'Hecha' AND COALESCE(t.fechaCompletado, t.fechaActualizacion) >= @d0 AND COALESCE(t.fechaCompletado, t.fechaActualizacion) < @d1 THEN 1 ELSE 0 END) AS hechas, SUM(CASE WHEN t.idTarea IS NOT NULL AND t.estado = 'EnCurso' THEN 1 ELSE 0 END) AS enCurso, SUM(CASE WHEN t.idTarea IS NOT NULL AND t.estado = 'Bloqueada' AND t.activo = 1 THEN 1 ELSE 0 END) AS bloqueadas, SUM(CASE WHEN t.idTarea IS NOT NULL AND t.estado = 'Descartada' AND t.fechaActualizacion >= @d0 AND t.fechaActualizacion < @d1 THEN 1 ELSE 0 END) AS descartadas FROM UsuariosFiltrados uf LEFT JOIN p_TareaAsignados ta ON ta.carnet = uf.carnet LEFT JOIN p_Tareas t ON t.idTarea = ta.idTarea AND t.activo = 1 AND ( t.estado IN ('Pendiente','EnCurso','Pausa','Bloqueada','Revision') OR (t.estado = 'Hecha' AND COALESCE(t.fechaCompletado, t.fechaActualizacion) >= @d0 AND COALESCE(t.fechaCompletado, t.fechaActualizacion) < @d1) OR (t.estado = 'Descartada' AND t.fechaActualizacion >= @d0 AND t.fechaActualizacion < @d1) OR t.estado IN ('EnCurso', 'Bloqueada') ) GROUP BY uf.idUsuario, uf.carnet OPTION (RECOMPILE); END
GO